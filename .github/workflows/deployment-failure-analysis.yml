name: Deployment Failure Analysis
on:
  repository_dispatch:
    types: [deployment-failed]

jobs:
  analyze-failure:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Get recent commits for analysis
          ref: ${{ github.event.client_payload.commitSha }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Analyze Deployment Failure
        id: analyze
        run: |
          # Extract deployment context from event
          COMMIT_SHA="${{ github.event.client_payload.commitSha }}"
          ERROR_MESSAGE="${{ github.event.client_payload.error }}"
          PROJECT_NAME="${{ github.event.client_payload.projectName }}"
          DEPLOYMENT_URL="${{ github.event.client_payload.deploymentUrl }}"
          COMMIT_MESSAGE="${{ github.event.client_payload.commitMessage }}"
          
          echo "ðŸ” Analyzing deployment failure for commit: $COMMIT_SHA"
          echo "ðŸ“ Error: $ERROR_MESSAGE"
          
          # Analyze recent commits and changes
          echo "ðŸ“Š Getting recent commits..."
          git log --oneline -5 > recent_commits.txt
          
          echo "ðŸ“ Getting changed files..."
          git show --name-only $COMMIT_SHA > changed_files.txt 2>/dev/null || echo "Unable to get changed files for commit $COMMIT_SHA" > changed_files.txt
          
          # Analyze error patterns and provide specific suggestions
          LIKELY_CAUSE=""
          SUGGESTED_FIXES=""
          URGENCY="Medium"
          
          if echo "$ERROR_MESSAGE" | grep -i "module not found\|cannot resolve"; then
            LIKELY_CAUSE="Missing import or incorrect file path"
            SUGGESTED_FIXES="â€¢ Check if imported files exist and paths are correct\nâ€¢ Verify import statements match actual file names (case-sensitive)\nâ€¢ Ensure relative paths are correct (../ vs ./)"
            URGENCY="High"
          elif echo "$ERROR_MESSAGE" | grep -i "syntax error\|unexpected token"; then
            LIKELY_CAUSE="Syntax error in recent code changes"
            SUGGESTED_FIXES="â€¢ Check syntax in recently modified files\nâ€¢ Look for missing brackets, semicolons, or quotes\nâ€¢ Verify JSX syntax is correct"
            URGENCY="High"
          elif echo "$ERROR_MESSAGE" | grep -i "type error\|typescript"; then
            LIKELY_CAUSE="TypeScript type mismatch or missing type definitions"
            SUGGESTED_FIXES="â€¢ Run \`npm run type\` locally to see detailed type errors\nâ€¢ Check for missing type imports\nâ€¢ Verify interface/type definitions match usage"
            URGENCY="Medium"
          elif echo "$ERROR_MESSAGE" | grep -i "dependency\|npm\|yarn\|package"; then
            LIKELY_CAUSE="Dependency installation or version conflict"
            SUGGESTED_FIXES="â€¢ Clear node_modules and reinstall: \`rm -rf node_modules && npm install\`\nâ€¢ Check for version conflicts in package.json\nâ€¢ Verify all dependencies are listed in package.json"
            URGENCY="High"
          elif echo "$ERROR_MESSAGE" | grep -i "eslint\|lint"; then
            LIKELY_CAUSE="Code linting errors preventing build"
            SUGGESTED_FIXES="â€¢ Run \`npm run lint\` locally to see specific errors\nâ€¢ Fix linting issues or update ESLint configuration\nâ€¢ Consider using \`npm run lint-fix\` for auto-fixable issues"
            URGENCY="Low"
          elif echo "$ERROR_MESSAGE" | grep -i "build failed\|exit code 1"; then
            LIKELY_CAUSE="Generic build failure - check build logs for details"
            SUGGESTED_FIXES="â€¢ Check Vercel build logs for detailed error messages\nâ€¢ Test build locally: \`npm run build\`\nâ€¢ Verify environment variables are set correctly"
            URGENCY="Medium"
          else
            LIKELY_CAUSE="Unknown build error - manual investigation required"
            SUGGESTED_FIXES="â€¢ Check Vercel dashboard for detailed build logs\nâ€¢ Test build process locally\nâ€¢ Review recent code changes for potential issues"
            URGENCY="Medium"
          fi
          
          # Create comprehensive analysis report
          cat << EOF > analysis_report.md
          ## ðŸš¨ Deployment Failure Analysis
          
          ### ðŸ“Š Failure Details
          - **Project**: $PROJECT_NAME
          - **Failed Commit**: [\`${COMMIT_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA)
          - **Commit Message**: "$COMMIT_MESSAGE"
          - **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Deployment URL**: $DEPLOYMENT_URL
          - **Urgency**: **$URGENCY**
          
          ### âŒ Error Message
          \`\`\`
          $ERROR_MESSAGE
          \`\`\`
          
          ### ðŸ” Automated Analysis
          **Likely Cause**: $LIKELY_CAUSE
          
          **Suggested Fixes**:
          $SUGGESTED_FIXES
          
          ### ðŸ“ Files Modified in Failed Commit
          \`\`\`
          $(cat changed_files.txt)
          \`\`\`
          
          ### ðŸ“ˆ Recent Commit History
          \`\`\`
          $(cat recent_commits.txt)
          \`\`\`
          
          ### ðŸ“‹ Investigation Checklist
          - [ ] **Review changed files** in the failed commit above
          - [ ] **Check Vercel build logs** for additional error details
          - [ ] **Test locally**: Run \`npm run build\` to reproduce the error
          - [ ] **Verify dependencies**: Run \`npm install\` and check for conflicts
          - [ ] **Check environment variables** in Vercel dashboard
          
          ### ðŸ”§ Quick Debugging Commands
          \`\`\`bash
          # Test build locally
          npm run build
          
          # Check for type errors
          npm run type
          
          # Check for linting issues
          npm run lint
          
          # Reinstall dependencies
          rm -rf node_modules package-lock.json
          npm install
          \`\`\`
          
          ### ðŸ”— Useful Links
          - [Vercel Dashboard](https://vercel.com/dashboard)
          - [Build Logs](https://vercel.com/$PROJECT_NAME)
          - [Vercel Build Troubleshooting](https://vercel.com/docs/deployments/troubleshoot-a-build)
          - [Next.js Build Errors](https://nextjs.org/docs/messages)
          
          ### ðŸ¤– Next Steps
          1. **Review the analysis above** and try the suggested fixes
          2. **Test changes locally** before pushing to avoid repeated failures
          3. **Close this issue** once the deployment is fixed
          4. **Consider adding tests** to prevent similar issues
          
          ---
          *ðŸ¤– Auto-generated by GitHub Actions Deployment Monitor*  
          *Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
          
          echo "âœ… Analysis report generated"
          echo "analysis_ready=true" >> $GITHUB_OUTPUT
          echo "urgency=$URGENCY" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Issue
        if: steps.analyze.outputs.analysis_ready == 'true'
        uses: actions/github-script@v7
        id: create-issue
        with:
          script: |
            const fs = require('fs');
            const analysisReport = fs.readFileSync('analysis_report.md', 'utf8');
            const urgency = '${{ steps.analyze.outputs.urgency }}';
            
            // Determine labels based on urgency and error type
            const labels = ['deployment-failure', 'automated-analysis'];
            if (urgency === 'High') labels.push('priority-high');
            if (urgency === 'Medium') labels.push('priority-medium');
            if (urgency === 'Low') labels.push('priority-low');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Deployment Failure: ${{ github.event.client_payload.projectName }} [${urgency} Priority]`,
              body: analysisReport,
              labels: labels,
              assignees: ['${{ github.repository_owner }}']
            });
            
            console.log(`âœ… Created issue #${issue.data.number}: ${issue.data.html_url}`);
            
            // Set outputs for email notification
            core.setOutput('issue_url', issue.data.html_url);
            core.setOutput('issue_number', issue.data.number);
            
            return issue.data;
      
      - name: Analysis Complete
        run: |
          echo "âœ… Deployment failure analysis completed successfully!"
          echo "ðŸ“§ Email already sent via Resend from webhook handler"
          echo "ðŸ”— GitHub issue created: ${{ steps.create-issue.outputs.issue_url }}"
          echo "ðŸŽ¯ Priority level: ${{ steps.analyze.outputs.urgency }}"
          echo ""
          echo "ðŸ’¡ The user has been notified via email with direct links to:"
          echo "   - This GitHub issue for detailed analysis"
          echo "   - GitHub Actions for workflow status"
          echo "   - Vercel Dashboard for deployment logs"
          echo ""
          echo "ðŸš€ System working perfectly with Resend integration!"
      
